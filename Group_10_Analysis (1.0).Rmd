---
title: "Influential factors of days spent at the shelter"
author: "Hanfan Chen 2703334C, Zhaohao Li 2611602L, Zhenhao Qiao 2612824Q, Chao Wang 2518608W, RachaelWatson 2195719W"
output:
  pdf_document:
    number_sections: yes
fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(eval = T, echo = FALSE, comment = NA, message = FALSE, warning = FALSE)
```

# Introduction

```{r library}
library(ggplot2)
library(GGally)
library(tidyverse)
library(kableExtra)
library(pscl)
library(countreg)
library(sjPlot)
```

# Exploratory Data Analysis
```{r read the data}
data10 <- read.csv("dataset10.csv")
str(data10)
```

```{r}
for (i in 1:6) {
  cat("Column", i,":\n")
  print(levels(as.factor(data10[,i])))
  cat("\n")
}
data10[,2] <- as.factor(data10[,2])
data10[,3] <- as.factor(data10[,3])
```
All the explanatory variable are categorical variable and each explanatory variable have multiple levels.

```{r}
sum(data10$time_at_shelter == 0)
```
Over 300 zeros in raw data may cause overdispersion in Poisson regression. The negative binomial model is suggested to fit.

```{r hist of y, fig.cap = "\\label{fig:y_hist} The histogram of day time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
ggplot(data10, mapping = aes(x = time_at_shelter)) + 
  geom_histogram(bins = 25)
```
Figure \ref{fig:y_hist} displays the histogram of the response variable, which is days time in the shelter. The histogram shows evidence of right-skewed and Poisson distribution of the response variable.

```{r pair plots, fig.cap = "\\label{fig:pairs} Pair plots of the variables", fig.width = 10, fig.align = "center", fig.pos = "H"}
ggpairs(data10, lower="blank", axisLabels="none")
```
The explanatory variables are all categorical and their box plots are shown. The median time at shelter appears to be low for all the explanatory variables, which is due to the median time at shelter being `r quantile(data10$time_at_shelter, prob=c(.5))`.


Since in Figure\ref{fig:y_hist} the response variable is right-skewed, a median of the response variable is calculated. The figures below display the median of each category of the different explanatory variables.
```{r bar plot 1, fig.cap = "\\label{fig:animal_bar} Bar plot of animal type vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
animal_bar <- data10 %>% 
  group_by(animal_type) %>% 
  summarise(median = median(time_at_shelter))
ggplot(animal_bar, aes(x = animal_type, y = median, colour=animal_type, fill=animal_type)) +
  geom_col() +
  labs(x="Animal type", y="Time at Shelter")
```

```{r table of animal type summarise}
animal_categ <- data10 %>%
  group_by(animal_type) %>% 
  summarise(n=n(),Mean= mean(time_at_shelter), St.Dev = sd(time_at_shelter), Min=min(time_at_shelter), Q1 = quantile(time_at_shelter,0.25), Median=median(time_at_shelter), Q3 = quantile(time_at_shelter,0.75), Max=max(time_at_shelter)) 
kable(animal_categ, caption = "Summary statistics on the time at shelter by animal type") %>% 
  kable_styling(font_size = 10, latex_options = "hold_position")
```

```{r bar plot 2, fig.cap = "\\label{fig:month_bar} Bar plot of month vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
month_bar <- data10 %>% 
  group_by(month) %>% 
  summarise(median = median(time_at_shelter))
ggplot(month_bar, aes(x = month, y = median, fill=month)) +
  geom_col() +
  labs(x="Month", y="Time at Shelter")
```

```{r table of month summarise}
month_categ <- data10 %>%
  group_by(month) %>% 
  summarise(n=n(),Mean= mean(time_at_shelter), St.Dev = sd(time_at_shelter), Min=min(time_at_shelter), Q1 = quantile(time_at_shelter,0.25), Median=median(time_at_shelter), Q3 = quantile(time_at_shelter,0.75), Max=max(time_at_shelter)) 
kable(month_categ, caption = "Summary statistics on the time at shelter by month") %>% 
  kable_styling(font_size = 10, latex_options = "hold_position")
```

```{r bar plot 3, fig.cap = "\\label{fig:year_bar} Bar plot of year vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
year_bar <- data10 %>% 
  group_by(year) %>% 
  summarise(median = median(time_at_shelter))
ggplot(year_bar, aes(x = year, y = median, fill=year)) +
  geom_col() +
  labs(x="Year", y="Time at Shelter")
```

```{r}
month_2016 <- data10 %>% 
  filter(year==2016)  
  
month_2017 <- data10 %>% 
  filter(year==2017) 
unique(as.character(unique(month_2016$month)) %in% as.character(unique(month_2017$month)))
```
No overlap between the months and years, according to the bar plot\ref{fig:year_bar}, no obvious difference between two years and the relationship between the response variable and month variable is similar to that relationship between the response variable and the year variable. Therefore, the year variable is removed.

```{r}
data10 <- data10[,-3]
```

```{r bar plot 4, fig.cap = "\\label{fig:intake_bar} Bar plot of intake type vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
intake_bar <- data10 %>% 
  group_by(intake_type) %>% 
  summarise(median = median(time_at_shelter))
ggplot(intake_bar, aes(x = intake_type, y = median, fill=intake_type)) +
  geom_col() +
  labs(x="Intake type", y="Time at Shelter")
```

```{r table of intake type summarise}
intake_categ <- data10 %>%
  group_by(intake_type) %>% 
  summarise(n=n(),Mean= mean(time_at_shelter), St.Dev = sd(time_at_shelter), Min=min(time_at_shelter), Q1 = quantile(time_at_shelter,0.25), Median=median(time_at_shelter), Q3 = quantile(time_at_shelter,0.75), Max=max(time_at_shelter)) 
kable(intake_categ, caption = "Summary statistics on the time at shelter by intake type") %>% 
  kable_styling(font_size = 10, latex_options = "hold_position")
```

```{r bar plot 5, fig.cap = "\\label{fig:outcome_bar} Bar plot of outcome type vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
outcome_bar <- data10 %>% 
  group_by(outcome_type) %>% 
  summarise(median = median(time_at_shelter))
ggplot(outcome_bar, aes(x = outcome_type, y = median, fill=outcome_type)) +
  geom_col() +
  labs(x="Outcome type", y="Time at Shelter")
```

```{r table of outcome type summarise}
outcome_categ <- data10 %>%
  group_by(outcome_type) %>% 
  summarise(n=n(),Mean= mean(time_at_shelter), St.Dev = sd(time_at_shelter), Min=min(time_at_shelter), Q1 = quantile(time_at_shelter,0.25), Median=median(time_at_shelter), Q3 = quantile(time_at_shelter,0.75), Max=max(time_at_shelter)) 
kable(outcome_categ, caption = "Summary statistics on the time at shelter by outcome type") %>% 
  kable_styling(font_size = 10, latex_options = "hold_position")
```

```{r bar plot 6, fig.cap = "\\label{fig:chip_bar} Bar plot of chip status vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
chip_bar <- data10 %>% 
  group_by(chip_status) %>% 
  summarise(median = median(time_at_shelter))
ggplot(chip_bar, aes(x = chip_status, y = median, fill=chip_status)) +
  geom_col() +
  labs(x="Chip status", y="Time at Shelter")
```

```{r table of chip status summarise}
chips_categ <- data10 %>%
  group_by(chip_status) %>% 
  summarise(n=n(),Mean= mean(time_at_shelter), St.Dev = sd(time_at_shelter), Min=min(time_at_shelter), Q1 = quantile(time_at_shelter,0.25), Median=median(time_at_shelter), Q3 = quantile(time_at_shelter,0.75), Max=max(time_at_shelter)) 
kable(chips_categ, caption = "Summary statistics on the time at shelter by chips status") %>% 
  kable_styling(font_size = 10, latex_options = "hold_position")
```


# Formal Data Analysis

## Fitting a Poisson model
```{r Poisson model}
poisson_model <- glm(time_at_shelter ~ ., data = data10, family = "poisson")
summary(poisson_model)
```

The rootogram could be used to check the overdispersion. The line at 0 allows us to easily visualize where the model is over-fitting or under-fitting, if the bar is below the zero line then that value has been under-fitting. And if there is a space between the zero line and the bar then it has been over-fitting. For the model to be fitted correctly, the bar should sit as close to the zero line as possible.
```{r poisson rootogram,fig.cap = "\\label{fig:poisson_rootogram} Rootogram of Poisson Model", fig.width = 10, fig.align = "center", fig.pos = "H"}
rootogram(poisson_model, max = max(data10$time_at_shelter))

mu <- predict(poisson_model, type = "response")
exp <- sum(dpois(x = 0, lambda = mu))
```
From Figure\ref{fig:poisson_rootogram}, the Poisson model is severely under-fitting zero counts. There were `r sum(data10$time_at_shelter < 1)` zero counts observed in the data set but the model only fitted `r round(exp)`. It is also over-fitting the lower positive counts and under-fitting the higher counts, suggesting there is over-dispersion in the model. Hence a hurdle model will be fitted to provide a better fit.

## Fitting a Hurdle model
```{r Hurdle model}
hurdle_model <- hurdle(time_at_shelter ~ ., data = data10, dist = "poisson", zero.dist = "binomial")
summary(hurdle_model)
```

```{r binomial hurdle rootogram,fig.cap = "\\label{fig:binomial_hurdle_rootogram} Rootogram of Binomial Hurdle Model", fig.width = 10, fig.align = "center", fig.pos = "H"}
rootogram(hurdle_model, max = max(data10$time_at_shelter))
```
In Figure\ref{fig:binomial_hurdle_rootogram} Counts 1,2 and 4 are being severely under-fitted, while 6-9 are being over-fitted. There is also under-fitting at the higher counts which suggests over-dispersion. Therefore, a negative binomial hurdle model shall be fitted to address this. 

```{r fit negative binomial hurdle model}
hurdle_model_nb <- hurdle(time_at_shelter ~ ., data = data10, dist = "negbin")
```

```{r negative binomial hurdle rootogram,fig.cap = "\\label{fig:negative_binomial_hurdle_rootogram} Rootogram of Negative Binomial Hurdle Model", fig.width = 10, fig.align = "center", fig.pos = "H"}
rootogram(hurdle_model_nb, max = max(data10$time_at_shelter))
```
The AIC of the hurdle model is `r format(round(AIC(hurdle_model)), scientific=FALSE)` and the AIC of the negative binomial hurdle model is `r round(AIC(hurdle_model_nb))`. From this, the negative binomial model shows a much better fit to the data. However, in Figure\ref{fig:negative_binomial_hurdle_rootogram} some values are still being under-fitted.

### Variable selection using AIC
```{r all subset variable selection using AIC}
step(hurdle_model_nb, direction = "both")
```
Using AIC as a selection criteria, the model with the minimum AIC and hence the best fit for the data is the model with animal type, chip status, intake type and outcome type as the explanatory variables.
```{r new negative binomial hurdle model}
final_hurdle_model_nb <- hurdle(time_at_shelter ~ animal_type + intake_type + outcome_type + chip_status, data = data10, dist = "negbin")
```

### P-value and confidence intervals
```{r p-value}
summary(final_hurdle_model_nb)
```

```{r CI plots}
plot_model(final_hurdle_model_nb, show.values = T, transform = NULL, value.offset = 0.4, value.size = 2.8, dot.size = 1.3)
```

## Goodness of fit

```{r final rootogram,fig.cap = "\\label{fig:final_model_rootogram} Rootogram of Negative Binomial Hurdle Model with reduced variables", fig.width = 10, fig.align = "center", fig.pos = "H"}
rootogram(final_hurdle_model_nb, max=max(data10$time_at_shelter))
```

The final model provides an adequate fit to the data. It has the lowest AIC of `r round(AIC(final_hurdle_model_nb), 2)` and as seen from Figure \ref{fig:final_model_rootogram} fits most values well.
  
# Conclusions {#sec:Conc}

The model which provides the best fit to the data is one which includes animal type, intake type, outcome type and chip status as explanatory variables. Hence these factors are the most influential in determining the number of days an animal spends at the shelter before their final outcome is decided.