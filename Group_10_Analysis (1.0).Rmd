---
title: "Influential factors of days spent at the shelter"
author: "Hanfan Chen 2703334C, Zhaohao Li 2611602L, Zhenhao Qiao 2612824Q, Chao Wang 2518608W, RachaelWatson 2195719W"
output:
  pdf_document:
    number_sections: yes
fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(eval = T, echo = FALSE, comment = NA, message = FALSE, warning = FALSE)
```

# Introduction

```{r library}
library(ggplot2)
library(GGally)
library(tidyverse)
library(kableExtra)
library(pscl)
library(countreg)
library(sjPlot)
library(MuMIn)
```

# Exploratory Data Analysis
```{r read the data}
data10 <- read.csv("dataset10.csv")
str(data10)
```

```{r}
for (i in 1:6) {
  cat("Column", i,":\n")
  print(levels(as.factor(data10[,i])))
  cat("\n")
}
data10[,2] <- as.factor(data10[,2])
data10[,3] <- as.factor(data10[,3])
```
All the explanatory variable are categorical variable and each explanatory variable have multiple levels.

```{r}
sum(data10$time_at_shelter == 0)
```
Over 300 zeros in raw data may cause overdispersion in Poisson regression. The hurdle model is suggested to fit.

```{r hist of y, fig.cap = "\\label{fig:y_hist} The histogram of day time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
ggplot(data10, mapping = aes(x = time_at_shelter)) + 
  geom_histogram(bins = 25)
```
Figure \ref{fig:y_hist} displays the histogram of the response variable, which is days time in the shelter. The histogram shows evidence of right-skewed and Poisson distribution of the response variable.

```{r pair plots, fig.cap = "\\label{fig:pairs} Pair plots of the variables", fig.width = 10, fig.align = "center", fig.pos = "H"}
ggpairs(data10, lower="blank", axisLabels="none")
```

The explanatory variables are all categorical and their box plots are shown. The median time at shelter appears to be low for all the explanatory variables, which is due to the median time at shelter being `r quantile(data10$time_at_shelter, prob=c(.5))`.

Since in Figure\ref{fig:y_hist} the response variable is right-skewed, a median of the response variable is calculated. The figures below display the median of each category of the different explanatory variables.
```{r bar plot 1, fig.cap = "\\label{fig:animal_bar} Bar plot of animal type vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
animal_bar <- data10 %>% 
  group_by(animal_type) %>% 
  summarise(median = median(time_at_shelter))
ggplot(animal_bar, aes(x = animal_type, y = median, colour=animal_type, fill=animal_type)) +
  geom_col() +
  labs(x="Animal type", y="Time at Shelter")
```

```{r bar plot 2, fig.cap = "\\label{fig:month_bar} Bar plot of month vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
month_bar <- data10 %>% 
  group_by(month) %>% 
  summarise(median = median(time_at_shelter))
ggplot(month_bar, aes(x = month, y = median, fill=month)) +
  geom_col() +
  labs(x="Month", y="Time at Shelter")
```

```{r bar plot 3, fig.cap = "\\label{fig:year_bar} Bar plot of year vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
year_bar <- data10 %>% 
  group_by(year) %>% 
  summarise(median = median(time_at_shelter))
ggplot(year_bar, aes(x = year, y = median, fill=year)) +
  geom_col() +
  labs(x="Year", y="Time at Shelter")
```

```{r}
month_2016 <- data10 %>% 
  filter(year==2016)  
  
month_2017 <- data10 %>% 
  filter(year==2017) 
unique(as.character(unique(month_2016$month)) %in% as.character(unique(month_2017$month)))
```
No overlap between the months and years, according to the bar plot\ref{fig:year_bar}, no obvious difference between two years and the relationship between the response variable and month variable is similar to that relationship between the response variable and the year variable. Therefore, the year variable is removed.

```{r}
data10 <- data10[,-3]
```

```{r bar plot 4, fig.cap = "\\label{fig:intake_bar} Bar plot of intake type vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
intake_bar <- data10 %>% 
  group_by(intake_type) %>% 
  summarise(median = median(time_at_shelter))
ggplot(intake_bar, aes(x = intake_type, y = median, fill=intake_type)) +
  geom_col() +
  labs(x="Intake type", y="Time at Shelter")
```

```{r bar plot 5, fig.cap = "\\label{fig:outcome_bar} Bar plot of outcome type vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
outcome_bar <- data10 %>% 
  group_by(outcome_type) %>% 
  summarise(median = median(time_at_shelter))
ggplot(outcome_bar, aes(x = outcome_type, y = median, fill=outcome_type)) +
  geom_col() +
  labs(x="Outcome type", y="Time at Shelter")
```

```{r bar plot 6, fig.cap = "\\label{fig:chip_bar} Bar plot of chip status vs time at shelter", fig.width = 10, fig.align = "center", fig.pos = "H"}
chip_bar <- data10 %>% 
  group_by(chip_status) %>% 
  summarise(median = median(time_at_shelter))
ggplot(chip_bar, aes(x = chip_status, y = median, fill=chip_status)) +
  geom_col() +
  labs(x="Chip status", y="Time at Shelter")
```

# Formal Data Analysis

## Fitting a Poisson model
```{r Poisson model}
poisson_model <- glm(time_at_shelter ~ ., data = data10, family = "poisson")
summary(poisson_model)
```

```{r predict zeros use Poisson model}
mu <- predict(poisson_model, type = "response")
exp <- sum(dpois(x = 0, lambda = mu))
round(exp)
```

The rootogram could be used to check the overdispersion. The line at 0 allows us to easily visualize where the model is over-fitting or under-fitting, if the bar is below the zero line then that value has been under-fitting. And if there is a space between the zero line and the bar then it has been over-fitting. For the model to be fitted correctly, the bar should sit as close to the zero line as possible.
```{r poisson rootogram,fig.cap = "\\label{fig:poisson_rootogram} Rootogram of Poisson Model", fig.width = 10, fig.align = "center", fig.pos = "H"}
rootogram(poisson_model, max = max(data10$time_at_shelter))
```
From Figure\ref{fig:poisson_rootogram}, the Poisson model is severely under-fitting zero counts. There were `r sum(data10$time_at_shelter < 1)` zero counts observed in the data set but the model only fitted `r round(exp)`. It is also over-fitting the lower positive counts and under-fitting the higher counts, suggesting there is over-dispersion in the model. Hence a hurdle model will be fitted to provide a better fit.

## Fitting a Hurdle model
```{r Hurdle model}
hurdle_model <- hurdle(time_at_shelter ~ ., data = data10, dist = "poisson", zero.dist = "binomial")
summary(hurdle_model)
```

```{r predict zeros use Hurdle model}
sum(predict(hurdle_model, type = "prob")[,1])
```
The model is fitting the zero counts perfectly because of the model design to be.

```{r binomial hurdle rootogram,fig.cap = "\\label{fig:binomial_hurdle_rootogram} Rootogram of Binomial Hurdle Model", fig.width = 10, fig.align = "center", fig.pos = "H"}
rootogram(hurdle_model, max = max(data10$time_at_shelter))
```
In Figure\ref{fig:binomial_hurdle_rootogram} Counts 1,2 and 4 are being severely under-fitted, while 6-9 are being over-fitted. There is also under-fitting at the higher counts which suggests over-dispersion. Therefore, a negative binomial hurdle model shall be fitted to address this. 

```{r fit neg bin hurdle model}
hurdle_model_nb <- hurdle(time_at_shelter ~ ., data = data10, dist = "negbin")
```

```{r predict zeros use negative binomial Hurdle model}
sum(predict(hurdle_model_nb, type = "prob")[,1])
```

```{r negative binomial hurdle rootogram,fig.cap = "\\label{fig:negative_binomial_hurdle_rootogram} Rootogram of Negative Binomial Hurdle Model", fig.width = 10, fig.align = "center", fig.pos = "H"}

rootogram(hurdle_model_nb, max = 80)
```
The AIC of the hurdle model is `r format(round(AIC(hurdle_model)), scientific=FALSE)` and the AIC of the negative binomial hurdle model is `r round(AIC(hurdle_model_nb))`. From this, the negative binomial model shows a much better fit to the data. However, in Figure\ref{fig:negative_binomial_hurdle_rootogram} some values are still being under-fitted.

### All subset variable selection using AIC
```{r all subset variable selection using AIC}
options(na.action = "na.fail")
combinations <- dredge(hurdle_model_nb, rank=AIC)
min_AIC <- which.min(combinations$AIC)
combinations[min_AIC]
```

Using AIC as a selection criteria, the model with the minimum AIC and hence the best fit for the data is the model with animal type, chip status, intake type and outcome type as the explanatory variables.

### p-value and confidence interval
```{r p-value}
summary(hurdle_model_nb)
```

```{r confidence intervals of negative binomial model}
nb_estim <- coef(summary(hurdle_model_nb))$zero[,"Estimate"]
nb_sd <- coef(summary(hurdle_model_nb))$zero[,"Std. Error"]
nb_upper <- nb_estim + 1.96*nb_sd
nb_lower <- nb_estim - 1.96*nb_sd

nb_CI <- as.data.frame(cbind(nb_estim, nb_lower, nb_upper))
nb_CI <- cbind(c(row.names(nb_CI)), nb_CI)
row.names(nb_CI) <- NULL
colnames(nb_CI)[1] <- "category"
# Delete intercept term
nb_CI <- nb_CI[-1,]
ggplot(nb_CI, aes(y = category, x = nb_estim, xmin = nb_lower, xmax = nb_upper)) + 
  geom_linerange() + 
  geom_pointrange() +
  geom_vline(xintercept = 0, col = "red")
  
# Delete variable animal_type
nb_CI <- nb_CI[-1:-3,]
ggplot(nb_CI, aes(y = category, x = nb_estim, xmin = nb_lower, xmax = nb_upper)) + 
  geom_linerange() + 
  geom_pointrange() +
  geom_vline(xintercept = 0, col = "red")

# Delete variable chip_status and variable month
nb_CI <- nb_CI[-1:-11,]
nb_CI <- nb_CI[-7:-8,]
ggplot(nb_CI, aes(y = category, x = nb_estim, xmin = nb_lower, xmax = nb_upper)) + 
  geom_linerange() + 
  geom_pointrange() +
  geom_vline(xintercept = 0, col = "red")
```

```{r confidence intervals of truncated Poisson model}
tP_estim <- coef(summary(hurdle_model_nb))$count[,"Estimate"]
tP_sd <- coef(summary(hurdle_model_nb))$count[,"Std. Error"]
tP_upper <- tP_estim + 1.96*tP_sd
tP_lower <- tP_estim - 1.96*tP_sd

tP_CI <- as.data.frame(cbind(tP_estim, tP_lower, tP_upper))
tP_CI <- cbind(row.names(tP_CI), tP_CI)
row.names(tP_CI) <- NULL
colnames(tP_CI)[1] <- "category"
# Delete intercept term
tP_CI <- tP_CI[-1,]
ggplot(tP_CI, aes(y = category, x = tP_estim, xmin = tP_lower, xmax = tP_upper)) + 
  geom_linerange() + 
  geom_pointrange() +
  geom_vline(xintercept = 0, col = "red")

# Delete variable animal_type
tP_CI <- tP_CI[-1:-3,]
ggplot(tP_CI, aes(y = category, x = tP_estim, xmin = tP_lower, xmax = tP_upper)) + 
  geom_linerange() + 
  geom_pointrange() +
  geom_vline(xintercept = 0, col = "red")
```


## Model checking

# Conclusions {#sec:Conc}






